<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五子棋在线对战</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5A2B',
                        secondary: '#D2B48C',
                        board: '#DEB887',
                        black: '#000000',
                        white: '#FFFFFF',
                        online: '#10B981',
                        offline: '#6B7280',
                        waiting: '#F59E0B',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .board-grid {
                background-size: 100% 100%;
                background-image: linear-gradient(to right, rgba(0,0,0,0.6) 1px, transparent 1px),
                                  linear-gradient(to bottom, rgba(0,0,0,0.6) 1px, transparent 1px);
            }
            .piece-shadow {
                filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
            }
            .piece-transition {
                transition: all 0.2s ease-out;
            }
            .btn-hover {
                transition: all 0.2s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .status-dot {
                @apply w-3 h-3 rounded-full inline-block ml-2;
            }
            .status-online {
                @apply bg-online;
            }
            .status-offline {
                @apply bg-offline;
            }
            .status-waiting {
                @apply bg-waiting animate-pulse-slow;
            }
            .glass-effect {
                @apply bg-white/80 backdrop-blur-md;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 font-sans">
    <!-- 主容器 -->
    <div class="max-w-4xl w-full bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-primary text-white p-6 text-center">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold">五子棋在线对战</h1>
            <p class="text-secondary mt-2">与好友一起体验经典对弈</p>
        </div>
        
        <!-- 游戏状态管理 -->
        <div id="appContainer">
            <!-- 1. 游戏大厅 -->
            <div id="lobbyScreen" class="p-6 md:p-8">
                <div class="max-w-md mx-auto">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-secondary rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-gamepad text-4xl text-primary"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">欢迎来到五子棋</h2>
                        <p class="text-gray-600 mt-2">请输入您的昵称开始游戏</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6 shadow-sm mb-6">
                        <div class="mb-4">
                            <label for="nicknameInput" class="block text-gray-700 font-medium mb-2">您的昵称</label>
                            <input type="text" id="nicknameInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="请输入昵称（2-10个字符）" maxlength="10">
                            <p id="nicknameError" class="text-red-500 text-sm mt-1 hidden">请输入有效的昵称</p>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button id="createRoomBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-plus mr-2"></i>创建房间
                            </button>
                            <button id="joinRoomBtn" class="flex-1 bg-secondary hover:bg-secondary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-sign-in-alt mr-2"></i>加入房间
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6 shadow-sm">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fa-solid fa-history mr-2 text-primary"></i>最近游戏
                        </h3>
                        <div id="recentGamesList" class="text-gray-600 text-sm">
                            <p class="text-center text-gray-500 italic">暂无游戏记录</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 2. 房间等待界面 -->
            <div id="roomScreen" class="p-6 md:p-8 hidden">
                <div class="max-w-md mx-auto">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">游戏房间</h2>
                        <p class="text-gray-600 mt-2">等待对手加入...</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6 shadow-sm mb-6">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-medium mb-2">房间号码</label>
                            <div class="flex">
                                <input type="text" id="roomIdDisplay" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg bg-gray-100 text-center font-mono font-bold" readonly>
                                <button id="copyRoomIdBtn" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary/90 transition-all">
                                    <i class="fa-solid fa-copy"></i>
                                </button>
                            </div>
                            <p class="text-gray-500 text-sm mt-1 text-center">复制房间号码并分享给好友</p>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-3">玩家列表</h3>
                            <div class="space-y-3">
                                <div id="player1Slot" class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center mr-3">
                                            <i class="fa-solid fa-user text-primary"></i>
                                        </div>
                                        <span id="player1Name" class="font-medium">等待中...</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span id="player1Status" class="text-xs px-2 py-1 rounded-full bg-waiting/20 text-waiting">准备中</span>
                                        <span class="status-dot status-waiting"></span>
                                    </div>
                                </div>
                                
                                <div id="player2Slot" class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                            <i class="fa-solid fa-user text-gray-400"></i>
                                        </div>
                                        <span id="player2Name" class="font-medium text-gray-400">等待中...</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span id="player2Status" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-500">等待中</span>
                                        <span class="status-dot status-offline"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="gameStatusInfo" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
                            <div class="flex items-start">
                                <i class="fa-solid fa-info-circle text-blue-500 mt-1 mr-3"></i>
                                <div>
                                    <h4 class="font-medium text-blue-700">游戏即将开始</h4>
                                    <p id="gameStatusMessage" class="text-sm text-blue-600 mt-1">请等待所有玩家准备就绪...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="startGameBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed hidden">
                            <i class="fa-solid fa-play mr-2"></i>开始游戏
                        </button>
                        <button id="leaveRoomBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                            <i class="fa-solid fa-sign-out-alt mr-2"></i>离开房间
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 3. 游戏界面 -->
            <div id="gameScreen" class="p-6 md:p-8 flex flex-col md:flex-row gap-6 hidden">
                <!-- 游戏区域 -->
                <div class="flex-1 relative">
                    <div class="aspect-square bg-board rounded-lg shadow-lg overflow-hidden board-grid" style="background-size: calc(100% / 14) calc(100% / 14);">
                        <canvas id="gameCanvas" class="w-full h-full cursor-pointer"></canvas>
                    </div>
                    
                    <div id="gameStatus" class="mt-4 p-3 bg-secondary/20 rounded-lg text-center">
                        <p id="statusText" class="font-medium">游戏开始! 黑棋先行</p>
                    </div>
                </div>
                
                <!-- 游戏控制和信息 -->
                <div class="w-full md:w-80 flex flex-col gap-6">
                    <div class="bg-gray-50 rounded-lg p-5 shadow-sm">
                        <h2 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fa-solid fa-users mr-2 text-primary"></i>玩家信息
                        </h2>
                        <div class="space-y-4">
                            <div id="currentPlayerInfo" class="flex items-center justify-between p-3 bg-primary/10 rounded-lg border border-primary/20">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center mr-3">
                                        <i class="fa-solid fa-user text-primary"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium" id="currentPlayerName">玩家1</div>
                                        <div class="text-xs text-gray-500 flex items-center">
                                            <span id="currentPlayerColor">黑棋</span>
                                            <span class="status-dot status-online ml-1"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-primary">当前回合</div>
                                    <div class="text-xs text-gray-500">思考中...</div>
                                </div>
                            </div>
                            
                            <div id="opponentPlayerInfo" class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                        <i class="fa-solid fa-user text-gray-400"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium" id="opponentPlayerName">玩家2</div>
                                        <div class="text-xs text-gray-500 flex items-center">
                                            <span id="opponentPlayerColor">白棋</span>
                                            <span class="status-dot status-online ml-1"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-gray-500">等待中</div>
                                    <div class="text-xs text-gray-500" id="opponentThinkTime">00:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-5 shadow-sm">
                        <h2 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fa-solid fa-clock mr-2 text-primary"></i>游戏信息
                        </h2>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">游戏时间</span>
                                <span id="gameTime" class="font-mono">00:00</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">步数</span>
                                <span id="moveCount">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">房间号码</span>
                                <span id="gameRoomId" class="font-mono text-sm">ABC123</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="restartBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                            <i class="fa-solid fa-refresh mr-2"></i>重新开始
                        </button>
                        <button id="undoBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                            <i class="fa-solid fa-undo mr-2"></i>悔棋
                        </button>
                    </div>
                    
                    <button id="exitGameBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i>退出游戏
                    </button>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-50 p-4 text-center text-sm text-gray-500">
            <p>© 2025 五子棋在线对战 | 与好友一起体验经典对弈</p>
        </div>
    </div>

    <!-- 模态框 -->
    <!-- 1. 加入房间模态框 -->
    <div id="joinRoomModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
            <div class="text-center mb-4">
                <h3 class="text-xl font-bold">加入房间</h3>
                <p class="text-gray-600 mt-1">请输入房间号码加入游戏</p>
            </div>
            
            <div class="mb-4">
                <label for="joinRoomIdInput" class="block text-gray-700 font-medium mb-2">房间号码</label>
                <input type="text" id="joinRoomIdInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="请输入6位房间号码" maxlength="6">
                <p id="joinRoomError" class="text-red-500 text-sm mt-1 hidden">房间不存在或已关闭</p>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="cancelJoinBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium btn-hover">
                    取消
                </button>
                <button id="confirmJoinBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover">
                    加入
                </button>
            </div>
        </div>
    </div>
    
    <!-- 2. 胜利提示模态框 -->
    <div id="winModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-trophy text-3xl text-yellow-500"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2" id="winnerText">黑棋获胜!</h2>
                <p class="text-gray-600 mb-6">恭喜您赢得了这场精彩的比赛!</p>
                <div class="flex gap-3">
                    <button id="newGameBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg font-medium btn-hover">
                        再来一局
                    </button>
                    <button id="backToLobbyBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium btn-hover">
                        返回大厅
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3. 断线提示模态框 -->
    <div id="disconnectModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-wifi-slash text-3xl text-red-500"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">连接断开</h2>
                <p class="text-gray-600 mb-4">与对手的连接已断开，正在尝试重新连接...</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div id="reconnectProgress" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-500 mb-6">重新连接中... <span id="reconnectTime">10</span>秒</p>
                <button id="leaveDisconnectBtn" class="bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-lg font-medium btn-hover">
                    离开房间
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 游戏常量
            const BOARD_SIZE = 15; // 15x15的棋盘
            const CELL_SIZE = Math.min(window.innerWidth * 0.8 / BOARD_SIZE, window.innerHeight * 0.6 / BOARD_SIZE);
            const PIECE_SIZE = CELL_SIZE * 0.8;
            
            // 应用状态
            let appState = {
                currentScreen: 'lobby', // 'lobby', 'room', 'game'
                playerName: '',
                roomId: null,
                isRoomCreator: false,
                connectionStatus: 'disconnected', // 'disconnected', 'connecting', 'connected'
                reconnectAttempts: 0,
                maxReconnectAttempts: 3,
                reconnectTimeout: null,
                broadcastChannel: null,
                opponentThinkTime: 0,
                opponentThinkTimer: null
            };
            
            // 游戏状态
            let gameState = {
                board: Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0)),
                currentPlayer: 1, // 1: 黑棋, 2: 白棋
                active: false,
                moveHistory: [],
                time: 0,
                timerInterval: null,
                playerColor: null, // 当前玩家的棋子颜色
                opponentName: '',
                opponentColor: null
            };
            
            // 房间数据
            let roomData = {
                id: null,
                players: [],
                status: 'waiting', // 'waiting', 'playing', 'finished'
                createdBy: null,
                createdAt: null
            };
            
            // DOM元素
            const elements = {
                // 大厅界面
                lobbyScreen: document.getElementById('lobbyScreen'),
                nicknameInput: document.getElementById('nicknameInput'),
                nicknameError: document.getElementById('nicknameError'),
                createRoomBtn: document.getElementById('createRoomBtn'),
                joinRoomBtn: document.getElementById('joinRoomBtn'),
                recentGamesList: document.getElementById('recentGamesList'),
                
                // 房间界面
                roomScreen: document.getElementById('roomScreen'),
                roomIdDisplay: document.getElementById('roomIdDisplay'),
                copyRoomIdBtn: document.getElementById('copyRoomIdBtn'),
                player1Name: document.getElementById('player1Name'),
                player1Status: document.getElementById('player1Status'),
                player2Name: document.getElementById('player2Name'),
                player2Status: document.getElementById('player2Status'),
                gameStatusInfo: document.getElementById('gameStatusInfo'),
                gameStatusMessage: document.getElementById('gameStatusMessage'),
                startGameBtn: document.getElementById('startGameBtn'),
                leaveRoomBtn: document.getElementById('leaveRoomBtn'),
                
                // 游戏界面
                gameScreen: document.getElementById('gameScreen'),
                canvas: document.getElementById('gameCanvas'),
                ctx: document.getElementById('gameCanvas').getContext('2d'),
                statusText: document.getElementById('statusText'),
                gameTimeEl: document.getElementById('gameTime'),
                moveCountEl: document.getElementById('moveCount'),
                gameRoomId: document.getElementById('gameRoomId'),
                currentPlayerName: document.getElementById('currentPlayerName'),
                currentPlayerColor: document.getElementById('currentPlayerColor'),
                opponentPlayerName: document.getElementById('opponentPlayerName'),
                opponentPlayerColor: document.getElementById('opponentPlayerColor'),
                opponentThinkTime: document.getElementById('opponentThinkTime'),
                restartBtn: document.getElementById('restartBtn'),
                undoBtn: document.getElementById('undoBtn'),
                exitGameBtn: document.getElementById('exitGameBtn'),
                
                // 模态框
                joinRoomModal: document.getElementById('joinRoomModal'),
                joinRoomIdInput: document.getElementById('joinRoomIdInput'),
                joinRoomError: document.getElementById('joinRoomError'),
                cancelJoinBtn: document.getElementById('cancelJoinBtn'),
                confirmJoinBtn: document.getElementById('confirmJoinBtn'),
                winModal: document.getElementById('winModal'),
                winnerText: document.getElementById('winnerText'),
                newGameBtn: document.getElementById('newGameBtn'),
                backToLobbyBtn: document.getElementById('backToLobbyBtn'),
                disconnectModal: document.getElementById('disconnectModal'),
                reconnectProgress: document.getElementById('reconnectProgress'),
                reconnectTime: document.getElementById('reconnectTime'),
                leaveDisconnectBtn: document.getElementById('leaveDisconnectBtn')
            };
            
            // 设置Canvas尺寸
            elements.canvas.width = CELL_SIZE * (BOARD_SIZE - 1);
            elements.canvas.height = CELL_SIZE * (BOARD_SIZE - 1);
            
            // ===== 初始化函数 =====
            
            // 初始化应用
            function initApp() {
                loadRecentGames();
                setupEventListeners();
                validateNickname();
            }
            
            // 设置事件监听器
            function setupEventListeners() {
                // 大厅界面事件
                elements.nicknameInput.addEventListener('input', validateNickname);
                elements.createRoomBtn.addEventListener('click', createRoom);
                elements.joinRoomBtn.addEventListener('click', showJoinRoomModal);
                
                // 房间界面事件
                elements.copyRoomIdBtn.addEventListener('click', copyRoomId);
                elements.leaveRoomBtn.addEventListener('click', leaveRoom);
                elements.startGameBtn.addEventListener('click', startGame);
                
                // 游戏界面事件
                elements.canvas.addEventListener('click', handleCanvasClick);
                elements.canvas.addEventListener('mousemove', handleCanvasMouseMove);
                elements.canvas.addEventListener('mouseleave', handleCanvasMouseLeave);
                elements.restartBtn.addEventListener('click', requestRestartGame);
                elements.undoBtn.addEventListener('click', requestUndoMove);
                elements.exitGameBtn.addEventListener('click', exitGame);
                
                // 模态框事件
                elements.cancelJoinBtn.addEventListener('click', hideJoinRoomModal);
                elements.confirmJoinBtn.addEventListener('click', joinRoom);
                elements.newGameBtn.addEventListener('click', requestRestartGame);
                elements.backToLobbyBtn.addEventListener('click', backToLobby);
                elements.leaveDisconnectBtn.addEventListener('click', leaveRoom);
            }
            
            // ===== 大厅界面函数 =====
            
            // 验证昵称
            function validateNickname() {
                const nickname = elements.nicknameInput.value.trim();
                const isValid = nickname.length >= 2 && nickname.length <= 10;
                
                elements.nicknameError.classList.toggle('hidden', isValid);
                elements.createRoomBtn.disabled = !isValid;
                elements.joinRoomBtn.disabled = !isValid;
                
                return isValid;
            }
            
            // 创建房间
            function createRoom() {
                if (!validateNickname()) return;
                
                appState.playerName = elements.nicknameInput.value.trim();
                appState.isRoomCreator = true;
                
                // 生成6位随机房间ID
                roomData.id = generateRoomId();
                roomData.createdBy = appState.playerName;
                roomData.createdAt = new Date().toISOString();
                roomData.players = [
                    {
                        id: 'player1',
                        name: appState.playerName,
                        color: 1, // 黑棋
                        isOnline: true,
                        isReady: true
                    }
                ];
                
                // 初始化广播通道
                initBroadcastChannel();
                
                // 更新房间界面
                updateRoomUI();
                
                // 切换到房间界面
                switchScreen('room');
                
                // 存储房间数据到localStorage
                saveRoomData();
            }
            
            // 显示加入房间模态框
            function showJoinRoomModal() {
                if (!validateNickname()) return;
                
                appState.playerName = elements.nicknameInput.value.trim();
                elements.joinRoomIdInput.value = '';
                elements.joinRoomError.classList.add('hidden');
                elements.joinRoomModal.classList.remove('hidden');
                
                setTimeout(() => {
                    elements.joinRoomModal.classList.add('opacity-100');
                    elements.joinRoomModal.querySelector('div').classList.remove('scale-95');
                    elements.joinRoomModal.querySelector('div').classList.add('scale-100');
                }, 10);
            }
            
            // 隐藏加入房间模态框
            function hideJoinRoomModal() {
                elements.joinRoomModal.classList.remove('opacity-100');
                elements.joinRoomModal.querySelector('div').classList.remove('scale-100');
                elements.joinRoomModal.querySelector('div').classList.add('scale-95');
                
                setTimeout(() => {
                    elements.joinRoomModal.classList.add('hidden');
                }, 300);
            }
            
            // 加入房间
            function joinRoom() {
                const roomId = elements.joinRoomIdInput.value.trim().toUpperCase();
                
                if (roomId.length !== 6) {
                    elements.joinRoomError.textContent = '请输入6位房间号码';
                    elements.joinRoomError.classList.remove('hidden');
                    return;
                }
                
                // 尝试从localStorage获取房间数据
                const savedRoomData = getRoomData(roomId);
                
                if (!savedRoomData) {
                    elements.joinRoomError.textContent = '房间不存在或已关闭';
                    elements.joinRoomError.classList.remove('hidden');
                    return;
                }
                
                // 检查房间是否已满
                if (savedRoomData.players.length >= 2) {
                    elements.joinRoomError.textContent = '房间已满';
                    elements.joinRoomError.classList.remove('hidden');
                    return;
                }
                
                // 设置应用状态
                appState.roomId = roomId;
                appState.isRoomCreator = false;
                
                // 更新房间数据
                roomData = savedRoomData;
                roomData.players.push({
                    id: 'player2',
                    name: appState.playerName,
                    color: 2, // 白棋
                    isOnline: true,
                    isReady: true
                });
                roomData.status = 'ready'; // 房间已准备好开始游戏
                
                // 初始化广播通道
                initBroadcastChannel();
                
                // 更新房间界面
                updateRoomUI();
                
                // 切换到房间界面
                switchScreen('room');
                
                // 保存更新后的房间数据
                saveRoomData();
                
                // 隐藏模态框
                hideJoinRoomModal();
                
                // 通知房间创建者有玩家加入
                sendMessage({
                    type: 'player_joined',
                    roomId: roomId,
                    playerName: appState.playerName
                });
            }
            
            // 加载最近游戏记录
            function loadRecentGames() {
                const recentGames = JSON.parse(localStorage.getItem('recentGames') || '[]');
                
                if (recentGames.length === 0) {
                    elements.recentGamesList.innerHTML = '<p class="text-center text-gray-500 italic">暂无游戏记录</p>';
                    return;
                }
                
                let html = '<ul class="space-y-2">';
                recentGames.slice(0, 5).forEach(game => {
                    const date = new Date(game.timestamp).toLocaleString();
                    const result = game.winner === appState.playerName ? 
                        '<span class="text-green-600 font-medium">胜利</span>' : 
                        (game.winner === 'draw' ? '<span class="text-yellow-600 font-medium">平局</span>' : '<span class="text-red-600 font-medium">失败</span>');
                    
                    html += `
                        <li class="flex justify-between items-center p-2 hover:bg-gray-100 rounded">
                            <span>${game.opponentName}</span>
                            <span>${result}</span>
                            <span class="text-gray-500 text-xs">${date}</span>
                        </li>
                    `;
                });
                html += '</ul>';
                
                elements.recentGamesList.innerHTML = html;
            }
            
            // ===== 房间界面函数 =====
            
            // 更新房间界面
            function updateRoomUI() {
                elements.roomIdDisplay.value = roomData.id;
                
                // 更新玩家信息
                if (roomData.players.length > 0) {
                    const player1 = roomData.players[0];
                    elements.player1Name.textContent = player1.name;
                    elements.player1Status.textContent = player1.isReady ? '准备就绪' : '准备中';
                    
                    if (roomData.players.length > 1) {
                        const player2 = roomData.players[1];
                        elements.player2Name.textContent = player2.name;
                        elements.player2Name.classList.remove('text-gray-400');
                        elements.player2Status.textContent = player2.isReady ? '准备就绪' : '准备中';
                        elements.player2Status.classList.remove('bg-gray-200', 'text-gray-500');
                        elements.player2Status.classList.add('bg-online/20', 'text-online');
                        document.querySelector('#player2Slot .status-dot').classList.remove('status-offline');
                        document.querySelector('#player2Slot .status-dot').classList.add('status-online');
                        document.querySelector('#player2Slot .w-8').classList.remove('bg-gray-200');
                        document.querySelector('#player2Slot .w-8').classList.add('bg-primary/20');
                        document.querySelector('#player2Slot .fa-user').classList.remove('text-gray-400');
                        document.querySelector('#player2Slot .fa-user').classList.add('text-primary');
                        
                        // 显示游戏即将开始信息
                        elements.gameStatusInfo.classList.remove('hidden');
                        elements.gameStatusMessage.textContent = '所有玩家已准备就绪，房主可以开始游戏';
                        
                        // 如果是房主，显示开始游戏按钮
                        if (appState.isRoomCreator) {
                            elements.startGameBtn.classList.remove('hidden');
                        }
                    }
                }
            }
            
            // 复制房间ID
            function copyRoomId() {
                elements.roomIdDisplay.select();
                document.execCommand('copy');
                
                // 显示复制成功提示
                const originalText = elements.copyRoomIdBtn.innerHTML;
                elements.copyRoomIdBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                
                setTimeout(() => {
                    elements.copyRoomIdBtn.innerHTML = originalText;
                }, 1500);
            }
            
            // 离开房间
            function leaveRoom() {
                // 通知其他玩家
                if (appState.connectionStatus === 'connected') {
                    sendMessage({
                        type: 'player_left',
                        roomId: roomData.id,
                        playerName: appState.playerName
                    });
                }
                
                // 清理广播通道
                cleanupBroadcastChannel();
                
                // 清理重连计时器
                if (appState.reconnectTimeout) {
                    clearTimeout(appState.reconnectTimeout);
                    appState.reconnectTimeout = null;
                }
                
                // 重置应用状态
                resetAppState();
                
                // 切换到大厅界面
                switchScreen('lobby');
                
                // 如果是房主，删除房间数据
                if (appState.isRoomCreator) {
                    deleteRoomData(roomData.id);
                }
            }
            
            // 开始游戏
            function startGame() {
                if (!appState.isRoomCreator || roomData.players.length < 2) return;
                
                // 更新房间状态
                roomData.status = 'playing';
                
                // 保存房间数据
                saveRoomData();
                
                // 设置游戏状态
                gameState.active = true;
                gameState.playerColor = appState.isRoomCreator ? 1 : 2; // 房主是黑棋
                gameState.opponentColor = gameState.playerColor === 1 ? 2 : 1;
                
                // 找到对手信息
                const opponent = roomData.players.find(p => p.id !== (appState.isRoomCreator ? 'player1' : 'player2'));
                gameState.opponentName = opponent ? opponent.name : '对手';
                
                // 通知另一个玩家游戏开始
                sendMessage({
                    type: 'game_started',
                    roomId: roomData.id,
                    board: gameState.board,
                    currentPlayer: gameState.currentPlayer
                });
                
                // 初始化游戏界面
                initGameUI();
                
                // 切换到游戏界面
                switchScreen('game');
                
                // 开始游戏计时器
                startGameTimer();
            }
            
            // ===== 游戏界面函数 =====
            
            // 初始化游戏界面
            function initGameUI() {
                // 设置房间ID显示
                elements.gameRoomId.textContent = roomData.id;
                
                // 设置玩家信息
                elements.currentPlayerName.textContent = appState.playerName;
                elements.currentPlayerColor.textContent = gameState.playerColor === 1 ? '黑棋' : '白棋';
                elements.opponentPlayerName.textContent = gameState.opponentName;
                elements.opponentPlayerColor.textContent = gameState.opponentColor === 1 ? '黑棋' : '白棋';
                
                // 绘制棋盘
                drawBoard();
                
                // 更新游戏状态显示
                updateGameStatus();
                
                // 重置游戏时间和步数
                gameState.time = 0;
                gameState.moveHistory = [];
                elements.gameTimeEl.textContent = '00:00';
                elements.moveCountEl.textContent = '0';
                
                // 重置对手思考时间
                gameState.opponentThinkTime = 0;
                elements.opponentThinkTime.textContent = '00:00';
            }
            
            // 绘制棋盘
            function drawBoard() {
                const ctx = elements.ctx;
                ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                
                // 绘制网格线
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 1.5;
                
                for (let i = 0; i < BOARD_SIZE; i++) {
                    // 水平线
                    ctx.beginPath();
                    ctx.moveTo(0, i * CELL_SIZE);
                    ctx.lineTo(elements.canvas.width, i * CELL_SIZE);
                    ctx.stroke();
                    
                    // 垂直线
                    ctx.beginPath();
                    ctx.moveTo(i * CELL_SIZE, 0);
                    ctx.lineTo(i * CELL_SIZE, elements.canvas.height);
                    ctx.stroke();
                }
                
                // 绘制天元和星位
                const starPoints = [
                    {x: 3, y: 3}, {x: 3, y: 11}, {x: 7, y: 7}, 
                    {x: 11, y: 3}, {x: 11, y: 11}
                ];
                
                starPoints.forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x * CELL_SIZE, point.y * CELL_SIZE, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#8B4513';
                    ctx.fill();
                });
                
                // 绘制棋子
                for (let i = 0; i < BOARD_SIZE; i++) {
                    for (let j = 0; j < BOARD_SIZE; j++) {
                        if (gameState.board[i][j] !== 0) {
                            drawPiece(i, j, gameState.board[i][j]);
                        }
                    }
                }
            }
            
            // 绘制棋子
            function drawPiece(row, col, player) {
                const ctx = elements.ctx;
                const x = col * CELL_SIZE;
                const y = row * CELL_SIZE;
                
                // 棋子阴影
                ctx.beginPath();
                ctx.arc(x, y, PIECE_SIZE / 2 + 2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fill();
                
                // 棋子本体
                ctx.beginPath();
                ctx.arc(x, y, PIECE_SIZE / 2, 0, Math.PI * 2);
                
                if (player === 1) {
                    // 黑棋 - 渐变效果
                    const gradient = ctx.createRadialGradient(
                        x - PIECE_SIZE / 6, y - PIECE_SIZE / 6, PIECE_SIZE / 10,
                        x, y, PIECE_SIZE / 2
                    );
                    gradient.addColorStop(0, '#555');
                    gradient.addColorStop(1, '#000');
                    ctx.fillStyle = gradient;
                } else {
                    // 白棋 - 渐变效果
                    const gradient = ctx.createRadialGradient(
                        x - PIECE_SIZE / 6, y - PIECE_SIZE / 6, PIECE_SIZE / 10,
                        x, y, PIECE_SIZE / 2
                    );
                    gradient.addColorStop(0, '#fff');
                    gradient.addColorStop(1, '#ddd');
                    ctx.fillStyle = gradient;
                }
                
                ctx.fill();
                
                // 棋子边缘
                ctx.strokeStyle = player === 1 ? '#333' : '#ccc';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
            
            // 处理棋盘点击事件
            function handleCanvasClick(e) {
                if (!gameState.active || gameState.currentPlayer !== gameState.playerColor) return;
                
                const rect = elements.canvas.getBoundingClientRect();
                const scaleX = elements.canvas.width / rect.width;
                const scaleY = elements.canvas.height / rect.height;
                
                // 计算点击的格子坐标
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                
                const col = Math.round(x / CELL_SIZE);
                const row = Math.round(y / CELL_SIZE);
                
                // 检查坐标是否在棋盘内且为空
                if (row >= 0 && row < BOARD_SIZE && col >= 0 && col < BOARD_SIZE && gameState.board[row][col] === 0) {
                    // 落子
                    gameState.board[row][col] = gameState.playerColor;
                    gameState.moveHistory.push({row, col, player: gameState.playerColor});
                    
                    // 添加落子动画效果
                    drawBoard();
                    
                    // 检查是否胜利
                    if (checkWin(row, col, gameState.playerColor)) {
                        handleWin(gameState.playerColor);
                        return;
                    }
                    
                    // 检查是否平局
                    if (checkDraw()) {
                        handleDraw();
                        return;
                    }
                    
                    // 切换玩家
                    gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                    updateGameStatus();
                    
                    // 重置对手思考时间
                    startOpponentThinkTimer();
                    
                    // 发送落子信息给对手
                    sendMessage({
                        type: 'make_move',
                        roomId: roomData.id,
                        row: row,
                        col: col,
                        player: gameState.playerColor,
                        board: gameState.board,
                        currentPlayer: gameState.currentPlayer
                    });
                }
            }
            
            // 处理鼠标移动事件（预览棋子）
            function handleCanvasMouseMove(e) {
                if (!gameState.active || gameState.currentPlayer !== gameState.playerColor) return;
                
                const rect = elements.canvas.getBoundingClientRect();
                const scaleX = elements.canvas.width / rect.width;
                const scaleY = elements.canvas.height / rect.height;
                
                // 计算鼠标所在的格子坐标
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                
                const col = Math.round(x / CELL_SIZE);
                const row = Math.round(y / CELL_SIZE);
                
                // 清除之前的预览
                drawBoard();
                
                // 如果坐标在棋盘内且为空，绘制预览棋子
                if (row >= 0 && row < BOARD_SIZE && col >= 0 && col < BOARD_SIZE && gameState.board[row][col] === 0) {
                    const ctx = elements.ctx;
                    ctx.beginPath();
                    ctx.arc(col * CELL_SIZE, row * CELL_SIZE, PIECE_SIZE / 2, 0, Math.PI * 2);
                    
                    if (gameState.playerColor === 1) {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    } else {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    }
                    
                    ctx.fill();
                }
            }
            
            // 处理鼠标离开事件
            function handleCanvasMouseLeave() {
                drawBoard();
            }
            
            // 检查胜利条件
            function checkWin(row, col, player) {
                const directions = [
                    [1, 0],   // 水平
                    [0, 1],   // 垂直
                    [1, 1],   // 对角线
                    [1, -1]   // 反对角线
                ];
                
                for (const [dx, dy] of directions) {
                    let count = 1;  // 当前位置已经有一个棋子
                    
                    // 正向检查
                    for (let i = 1; i < 5; i++) {
                        const newRow = row + i * dy;
                        const newCol = col + i * dx;
                        
                        if (newRow < 0 || newRow >= BOARD_SIZE || newCol < 0 || newCol >= BOARD_SIZE) {
                            break;
                        }
                        
                        if (gameState.board[newRow][newCol] === player) {
                            count++;
                        } else {
                            break;
                        }
                    }
                    
                    // 反向检查
                    for (let i = 1; i < 5; i++) {
                        const newRow = row - i * dy;
                        const newCol = col - i * dx;
                        
                        if (newRow < 0 || newRow >= BOARD_SIZE || newCol < 0 || newCol >= BOARD_SIZE) {
                            break;
                        }
                        
                        if (gameState.board[newRow][newCol] === player) {
                            count++;
                        } else {
                            break;
                        }
                    }
                    
                    if (count >= 5) {
                        return true;
                    }
                }
                
                return false;
            }
            
            // 检查平局
            function checkDraw() {
                for (let i = 0; i < BOARD_SIZE; i++) {
                    for (let j = 0; j < BOARD_SIZE; j++) {
                        if (gameState.board[i][j] === 0) {
                            return false; // 还有空位，不是平局
                        }
                    }
                }
                return true; // 棋盘已满，平局
            }
            
            // 更新游戏状态显示
            function updateGameStatus() {
                if (gameState.active) {
                    const isCurrentPlayerTurn = gameState.currentPlayer === gameState.playerColor;
                    elements.statusText.textContent = isCurrentPlayerTurn ? 
                        `游戏进行中 - 轮到您落子` : 
                        `游戏进行中 - 等待对手落子`;
                    
                    // 更新玩家信息显示
                    if (isCurrentPlayerTurn) {
                        document.getElementById('currentPlayerInfo').classList.add('bg-primary/10', 'border-primary/20');
                        document.getElementById('currentPlayerInfo').classList.remove('bg-white', 'border-gray-200');
                        document.querySelector('#currentPlayerInfo .text-right .text-sm').classList.add('text-primary');
                        document.querySelector('#currentPlayerInfo .text-right .text-sm').classList.remove('text-gray-500');
                        
                        document.getElementById('opponentPlayerInfo').classList.add('bg-white', 'border-gray-200');
                        document.getElementById('opponentPlayerInfo').classList.remove('bg-primary/10', 'border-primary/20');
                        document.querySelector('#opponentPlayerInfo .text-right .text-sm').classList.add('text-gray-500');
                        document.querySelector('#opponentPlayerInfo .text-right .text-sm').classList.remove('text-primary');
                    } else {
                        document.getElementById('currentPlayerInfo').classList.add('bg-white', 'border-gray-200');
                        document.getElementById('currentPlayerInfo').classList.remove('bg-primary/10', 'border-primary/20');
                        document.querySelector('#currentPlayerInfo .text-right .text-sm').classList.add('text-gray-500');
                        document.querySelector('#currentPlayerInfo .text-right .text-sm').classList.remove('text-primary');
                        
                        document.getElementById('opponentPlayerInfo').classList.add('bg-primary/10', 'border-primary/20');
                        document.getElementById('opponentPlayerInfo').classList.remove('bg-white', 'border-gray-200');
                        document.querySelector('#opponentPlayerInfo .text-right .text-sm').classList.add('text-primary');
                        document.querySelector('#opponentPlayerInfo .text-right .text-sm').classList.remove('text-gray-500');
                    }
                }
                
                elements.moveCountEl.textContent = gameState.moveHistory.length;
            }
            
            // 开始游戏计时器
            function startGameTimer() {
                clearInterval(gameState.timerInterval);
                gameState.time = 0;
                
                gameState.timerInterval = setInterval(() => {
                    gameState.time++;
                    const minutes = Math.floor(gameState.time / 60).toString().padStart(2, '0');
                    const seconds = (gameState.time % 60).toString().padStart(2, '0');
                    elements.gameTimeEl.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }
            
            // 停止游戏计时器
            function stopGameTimer() {
                clearInterval(gameState.timerInterval);
            }
            
            // 开始对手思考计时器
            function startOpponentThinkTimer() {
                clearInterval(gameState.opponentThinkTimer);
                gameState.opponentThinkTime = 0;
                
                gameState.opponentThinkTimer = setInterval(() => {
                    gameState.opponentThinkTime++;
                    const minutes = Math.floor(gameState.opponentThinkTime / 60).toString().padStart(2, '0');
                    const seconds = (gameState.opponentThinkTime % 60).toString().padStart(2, '0');
                    elements.opponentThinkTime.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }
            
            // 停止对手思考计时器
            function stopOpponentThinkTimer() {
                clearInterval(gameState.opponentThinkTimer);
            }
            
            // 处理胜利
            function handleWin(winner) {
                gameState.active = false;
                stopGameTimer();
                stopOpponentThinkTimer();
                
                const winnerName = winner === gameState.playerColor ? appState.playerName : gameState.opponentName;
                elements.winnerText.textContent = `${winnerName} 获胜!`;
                
                // 保存游戏记录
                saveGameRecord({
                    opponentName: gameState.opponentName,
                    winner: winner === gameState.playerColor ? appState.playerName : gameState.opponentName,
                    timestamp: new Date().toISOString()
                });
                
                // 显示胜利模态框
                elements.winModal.classList.remove('hidden');
                
                setTimeout(() => {
                    elements.winModal.classList.add('opacity-100');
                    elements.winModal.querySelector('div').classList.remove('scale-95');
                    elements.winModal.querySelector('div').classList.add('scale-100');
                }, 10);
                
                // 通知对手游戏结束
                sendMessage({
                    type: 'game_over',
                    roomId: roomData.id,
                    winner: winner,
                    winnerName: winnerName
                });
            }
            
            // 处理平局
            function handleDraw() {
                gameState.active = false;
                stopGameTimer();
                stopOpponentThinkTimer();
                
                elements.winnerText.textContent = '游戏结束 - 平局!';
                
                // 保存游戏记录
                saveGameRecord({
                    opponentName: gameState.opponentName,
                    winner: 'draw',
                    timestamp: new Date().toISOString()
                });
                
                // 显示胜利模态框
                elements.winModal.classList.remove('hidden');
                
                setTimeout(() => {
                    elements.winModal.classList.add('opacity-100');
                    elements.winModal.querySelector('div').classList.remove('scale-95');
                    elements.winModal.querySelector('div').classList.add('scale-100');
                }, 10);
                
                // 通知对手游戏结束
                sendMessage({
                    type: 'game_over',
                    roomId: roomData.id,
                    winner: 0, // 0表示平局
                    winnerName: '平局'
                });
            }
            
            // 请求重新开始游戏
            function requestRestartGame() {
                // 隐藏胜利模态框
                elements.winModal.classList.remove('opacity-100');
                elements.winModal.querySelector('div').classList.remove('scale-100');
                elements.winModal.querySelector('div').classList.add('scale-95');
                
                setTimeout(() => {
                    elements.winModal.classList.add('hidden');
                }, 300);
                
                // 如果是游戏中请求重新开始，需要发送请求给对手
                if (appState.currentScreen === 'game') {
                    sendMessage({
                        type: 'restart_request',
                        roomId: roomData.id,
                        playerName: appState.playerName
                    });
                    
                    // 显示等待对手响应的提示
                    elements.statusText.textContent = '等待对手同意重新开始...';
                    return;
                }
                
                // 否则直接重新开始游戏
                resetGame();
                
                // 通知对手游戏重新开始
                sendMessage({
                    type: 'game_restarted',
                    roomId: roomData.id,
                    board: gameState.board,
                    currentPlayer: gameState.currentPlayer
                });
            }
            
            // 请求悔棋
            function requestUndoMove() {
                if (!gameState.active || gameState.moveHistory.length === 0) return;
                
                // 发送悔棋请求给对手
                sendMessage({
                    type: 'undo_request',
                    roomId: roomData.id,
                    playerName: appState.playerName
                });
                
                // 显示等待对手响应的提示
                elements.statusText.textContent = '等待对手同意悔棋...';
            }
            
            // 重置游戏
            function resetGame() {
                gameState.board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
                gameState.currentPlayer = 1; // 黑棋先行
                gameState.active = true;
                gameState.moveHistory = [];
                gameState.time = 0;
                
                drawBoard();
                updateGameStatus();
                elements.gameTimeEl.textContent = '00:00';
                
                // 重置对手思考时间
                gameState.opponentThinkTime = 0;
                elements.opponentThinkTime.textContent = '00:00';
                
                startGameTimer();
            }
            
            // 退出游戏
            function exitGame() {
                // 确认对话框
                if (!confirm('确定要退出游戏吗？')) return;
                
                // 通知对手
                sendMessage({
                    type: 'player_left',
                    roomId: roomData.id,
                    playerName: appState.playerName
                });
                
                // 清理
                stopGameTimer();
                stopOpponentThinkTimer();
                cleanupBroadcastChannel();
                
                // 重置应用状态
                resetAppState();
                
                // 切换到大厅界面
                switchScreen('lobby');
            }
            
            // 返回大厅
            function backToLobby() {
                // 隐藏胜利模态框
                elements.winModal.classList.remove('opacity-100');
                elements.winModal.querySelector('div').classList.remove('scale-100');
                elements.winModal.querySelector('div').classList.add('scale-95');
                
                setTimeout(() => {
                    elements.winModal.classList.add('hidden');
                }, 300);
                
                // 清理
                stopGameTimer();
                stopOpponentThinkTimer();
                cleanupBroadcastChannel();
                
                // 重置应用状态
                resetAppState();
                
                // 切换到大厅界面
                switchScreen('lobby');
            }
            
            // ===== 通信相关函数 =====
            
            // 初始化广播通道
            function initBroadcastChannel() {
                // 在实际应用中，这里应该使用WebSocket连接
                // 由于我们只能使用前端技术，这里使用BroadcastChannel模拟
                appState.broadcastChannel = new BroadcastChannel('gobang-game');
                
                appState.broadcastChannel.onmessage = handleMessage;
                appState.broadcastChannel.onopen = () => {
                    appState.connectionStatus = 'connected';
                };
                appState.broadcastChannel.onclose = () => {
                    appState.connectionStatus = 'disconnected';
                    handleDisconnect();
                };
                appState.broadcastChannel.onerror = () => {
                    appState.connectionStatus = 'disconnected';
                    handleDisconnect();
                };
            }
            
            // 清理广播通道
            function cleanupBroadcastChannel() {
                if (appState.broadcastChannel) {
                    appState.broadcastChannel.close();
                    appState.broadcastChannel = null;
                }
            }
            
            // 发送消息
            function sendMessage(message) {
                if (!appState.broadcastChannel || appState.connectionStatus !== 'connected') {
                    return;
                }
                
                appState.broadcastChannel.postMessage({
                    ...message,
                    sender: appState.playerName,
                    timestamp: new Date().toISOString()
                });
            }
            
            // 处理接收到的消息
            function handleMessage(event) {
                const message = event.data;
                
                // 忽略自己发送的消息
                if (message.sender === appState.playerName) return;
                
                // 根据消息类型处理
                switch (message.type) {
                    case 'player_joined':
                        handlePlayerJoined(message);
                        break;
                    case 'player_left':
                        handlePlayerLeft(message);
                        break;
                    case 'game_started':
                        handleGameStarted(message);
                        break;
                    case 'make_move':
                        handleMakeMove(message);
                        break;
                    case 'game_over':
                        handleGameOver(message);
                        break;
                    case 'restart_request':
                        handleRestartRequest(message);
                        break;
                    case 'restart_response':
                        handleRestartResponse(message);
                        break;
                    case 'undo_request':
                        handleUndoRequest(message);
                        break;
                    case 'undo_response':
                        handleUndoResponse(message);
                        break;
                    case 'heartbeat':
                        handleHeartbeat(message);
                        break;
                }
            }
            
            // 处理玩家加入
            function handlePlayerJoined(message) {
                if (appState.currentScreen !== 'room' || roomData.id !== message.roomId) return;
                
                // 更新房间数据
                roomData.players.push({
                    id: 'player2',
                    name: message.playerName,
                    color: 2,
                    isOnline: true,
                    isReady: true
                });
                roomData.status = 'ready';
                
                // 保存房间数据
                saveRoomData();
                
                // 更新房间界面
                updateRoomUI();
            }
            
            // 处理玩家离开
            function handlePlayerLeft(message) {
                if (roomData.id !== message.roomId) return;
                
                // 如果在游戏中，显示对手离开的提示
                if (appState.currentScreen === 'game') {
                    alert('对手已离开游戏');
                    exitGame();
                    return;
                }
                
                // 如果在房间中，更新房间界面
                if (appState.currentScreen === 'room') {
                    // 移除离开的玩家
                    roomData.players = roomData.players.filter(p => p.name !== message.playerName);
                    
                    // 保存房间数据
                    saveRoomData();
                    
                    // 更新房间界面
                    elements.player2Name.textContent = '等待中...';
                    elements.player2Name.classList.add('text-gray-400');
                    elements.player2Status.textContent = '等待中';
                    elements.player2Status.classList.remove('bg-online/20', 'text-online');
                    elements.player2Status.classList.add('bg-gray-200', 'text-gray-500');
                    document.querySelector('#player2Slot .status-dot').classList.remove('status-online');
                    document.querySelector('#player2Slot .status-dot').classList.add('status-offline');
                    document.querySelector('#player2Slot .w-8').classList.remove('bg-primary/20');
                    document.querySelector('#player2Slot .w-8').classList.add('bg-gray-200');
                    document.querySelector('#player2Slot .fa-user').classList.remove('text-primary');
                    document.querySelector('#player2Slot .fa-user').classList.add('text-gray-400');
                    
                    // 隐藏游戏状态信息和开始游戏按钮
                    elements.gameStatusInfo.classList.add('hidden');
                    elements.startGameBtn.classList.add('hidden');
                }
            }
            
            // 处理游戏开始
            function handleGameStarted(message) {
                if (appState.currentScreen !== 'room' || roomData.id !== message.roomId) return;
                
                // 更新房间状态
                roomData.status = 'playing';
                
                // 保存房间数据
                saveRoomData();
                
                // 设置游戏状态
                gameState.active = true;
                gameState.board = message.board;
                gameState.currentPlayer = message.currentPlayer;
                gameState.playerColor = 2; // 加入者是白棋
                gameState.opponentColor = 1; // 创建者是黑棋
                gameState.opponentName = roomData.players[0].name;
                
                // 初始化游戏界面
                initGameUI();
                
                // 切换到游戏界面
                switchScreen('game');
                
                // 开始游戏计时器
                startGameTimer();
                
                // 如果不是当前玩家回合，开始对手思考计时器
                if (gameState.currentPlayer !== gameState.playerColor) {
                    startOpponentThinkTimer();
                }
            }
            
            // 处理落子
            function handleMakeMove(message) {
                if (appState.currentScreen !== 'game' || roomData.id !== message.roomId) return;
                
                // 更新游戏状态
                gameState.board = message.board;
                gameState.currentPlayer = message.currentPlayer;
                gameState.moveHistory.push({row: message.row, col: message.col, player: message.player});
                
                // 停止对手思考计时器
                stopOpponentThinkTimer();
                
                // 绘制棋盘
                drawBoard();
                
                // 更新游戏状态显示
                updateGameStatus();
                
                // 检查是否胜利
                if (checkWin(message.row, message.col, message.player)) {
                    handleWin(message.player);
                    return;
                }
                
                // 检查是否平局
                if (checkDraw()) {
                    handleDraw();
                    return;
                }
                
                // 如果是当前玩家回合，重置对手思考计时器
                if (gameState.currentPlayer === gameState.playerColor) {
                    gameState.opponentThinkTime = 0;
                    elements.opponentThinkTime.textContent = '00:00';
                } else {
                    startOpponentThinkTimer();
                }
            }
            
            // 处理游戏结束
            function handleGameOver(message) {
                if (appState.currentScreen !== 'game' || roomData.id !== message.roomId) return;
                
                gameState.active = false;
                stopGameTimer();
                stopOpponentThinkTimer();
                
                elements.winnerText.textContent = message.winner === 0 ? 
                    '游戏结束 - 平局!' : 
                    `${message.winnerName} 获胜!`;
                
                // 保存游戏记录
                saveGameRecord({
                    opponentName: gameState.opponentName,
                    winner: message.winner === gameState.playerColor ? appState.playerName : 
                           (message.winner === 0 ? 'draw' : gameState.opponentName),
                    timestamp: new Date().toISOString()
                });
                
                // 显示胜利模态框
                elements.winModal.classList.remove('hidden');
                
                setTimeout(() => {
                    elements.winModal.classList.add('opacity-100');
                    elements.winModal.querySelector('div').classList.remove('scale-95');
                    elements.winModal.querySelector('div').classList.add('scale-100');
                }, 10);
            }
            
            // 处理重新开始请求
            function handleRestartRequest(message) {
                if (appState.currentScreen !== 'game' || roomData.id !== message.roomId) return;
                
                // 显示确认对话框
                const accept = confirm(`${message.playerName} 请求重新开始游戏，是否同意？`);
                
                // 发送响应
                sendMessage({
                    type: 'restart_response',
                    roomId: roomData.id,
                    playerName: appState.playerName,
                    accepted: accept
                });
                
                // 如果同意，重置游戏
                if (accept) {
                    resetGame();
                } else {
                    elements.statusText.textContent = '游戏继续';
                }
            }
            
            // 处理重新开始响应
            function handleRestartResponse(message) {
                if (appState.currentScreen !== 'game' || roomData.id !== message.roomId) return;
                
                if (message.accepted) {
                    resetGame();
                } else {
                    elements.statusText.textContent = '游戏继续';
                    alert('对手拒绝了重新开始的请求');
                }
            }
            
            // 处理悔棋请求
            function handleUndoRequest(message) {
                if (appState.currentScreen !== 'game' || roomData.id !== message.roomId) return;
                
                // 显示确认对话框
                const accept = confirm(`${message.playerName} 请求悔棋，是否同意？`);
                
                // 发送响应
                sendMessage({
                    type: 'undo_response',
                    roomId: roomData.id,
                    playerName: appState.playerName,
                    accepted: accept
                });
                
                // 如果同意，执行悔棋
                if (accept) {
                    if (gameState.moveHistory.length > 0) {
                        const lastMove = gameState.moveHistory.pop();
                        gameState.board[lastMove.row][lastMove.col] = 0;
                        gameState.currentPlayer = lastMove.player;
                        
                        drawBoard();
                        updateGameStatus();
                    }
                } else {
                    elements.statusText.textContent = '游戏继续';
                }
            }
            
            // 处理悔棋响应
            function handleUndoResponse(message) {
                if (appState.currentScreen !== 'game' || roomData.id !== message.roomId) return;
                
                if (message.accepted) {
                    elements.statusText.textContent = '悔棋成功';
                } else {
                    elements.statusText.textContent = '游戏继续';
                    alert('对手拒绝了悔棋的请求');
                }
            }
            
            // 处理心跳
            function handleHeartbeat(message) {
                // 更新连接状态
                appState.connectionStatus = 'connected';
                
                // 重置重连尝试次数
                appState.reconnectAttempts = 0;
                
                // 如果正在显示断线模态框，隐藏它
                if (!elements.disconnectModal.classList.contains('hidden')) {
                    hideDisconnectModal();
                }
                
                // 回复心跳
                sendMessage({
                    type: 'heartbeat_response',
                    roomId: message.roomId,
                    timestamp: new Date().toISOString()
                });
            }
            
            // 处理连接断开
            function handleDisconnect() {
                if (appState.connectionStatus === 'disconnected') return;
                
                appState.connectionStatus = 'disconnected';
                
                // 如果在游戏中，显示断线模态框
                if (appState.currentScreen === 'game') {
                    showDisconnectModal();
                }
            }
            
            // 显示断线模态框
            function showDisconnectModal() {
                elements.disconnectModal.classList.remove('hidden');
                
                setTimeout(() => {
                    elements.disconnectModal.classList.add('opacity-100');
                    elements.disconnectModal.querySelector('div').classList.remove('scale-95');
                    elements.disconnectModal.querySelector('div').classList.add('scale-100');
                }, 10);
                
                // 开始重连倒计时
                let reconnectTime = 10;
                elements.reconnectTime.textContent = reconnectTime;
                
                const reconnectInterval = setInterval(() => {
                    reconnectTime--;
                    elements.reconnectTime.textContent = reconnectTime;
                    elements.reconnectProgress.style.width = `${(10 - reconnectTime) * 10}%`;
                    
                    if (reconnectTime <= 0) {
                        clearInterval(reconnectInterval);
                        
                        // 尝试重新连接
                        if (appState.reconnectAttempts < appState.maxReconnectAttempts) {
                            appState.reconnectAttempts++;
                            initBroadcastChannel();
                            
                            // 发送心跳消息
                            setTimeout(() => {
                                sendMessage({
                                    type: 'heartbeat',
                                    roomId: roomData.id,
                                    timestamp: new Date().toISOString()
                                });
                            }, 1000);
                            
                            // 等待响应
                            appState.reconnectTimeout = setTimeout(() => {
                                if (appState.connectionStatus === 'disconnected') {
                                    showDisconnectModal();
                                }
                            }, 3000);
                        } else {
                            // 重连失败，隐藏模态框
                            hideDisconnectModal();
                            
                            // 显示连接失败提示
                            alert('连接失败，请重新进入游戏');
                            
                            // 退出游戏
                            exitGame();
                        }
                    }
                }, 1000);
            }
            
            // 隐藏断线模态框
            function hideDisconnectModal() {
                elements.disconnectModal.classList.remove('opacity-100');
                elements.disconnectModal.querySelector('div').classList.remove('scale-100');
                elements.disconnectModal.querySelector('div').classList.add('scale-95');
                
                setTimeout(() => {
                    elements.disconnectModal.classList.add('hidden');
                }, 300);
            }
            
            // ===== 工具函数 =====
            
            // 切换屏幕
            function switchScreen(screen) {
                appState.currentScreen = screen;
                
                // 隐藏所有屏幕
                elements.lobbyScreen.classList.add('hidden');
                elements.roomScreen.classList.add('hidden');
                elements.gameScreen.classList.add('hidden');
                
                // 显示目标屏幕
                switch (screen) {
                    case 'lobby':
                        elements.lobbyScreen.classList.remove('hidden');
                        break;
                    case 'room':
                        elements.roomScreen.classList.remove('hidden');
                        break;
                    case 'game':
                        elements.gameScreen.classList.remove('hidden');
                        break;
                }
            }
            
            // 生成房间ID
            function generateRoomId() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                return result;
            }
            
            // 保存房间数据
            function saveRoomData() {
                localStorage.setItem(`room_${roomData.id}`, JSON.stringify(roomData));
            }
            
            // 获取房间数据
            function getRoomData(roomId) {
                const data = localStorage.getItem(`room_${roomId}`);
                return data ? JSON.parse(data) : null;
            }
            
            // 删除房间数据
            function deleteRoomData(roomId) {
                localStorage.removeItem(`room_${roomId}`);
            }
            
            // 保存游戏记录
            function saveGameRecord(record) {
                const recentGames = JSON.parse(localStorage.getItem('recentGames') || '[]');
                recentGames.unshift(record);
                
                // 只保留最近10条记录
                if (recentGames.length > 10) {
                    recentGames.pop();
                }
                
                localStorage.setItem('recentGames', JSON.stringify(recentGames));
            }
            
            // 重置应用状态
            function resetAppState() {
                appState.currentScreen = 'lobby';
                appState.roomId = null;
                appState.isRoomCreator = false;
                appState.connectionStatus = 'disconnected';
                appState.reconnectAttempts = 0;
                
                gameState.board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
                gameState.currentPlayer = 1;
                gameState.active = false;
                gameState.moveHistory = [];
                gameState.time = 0;
                gameState.playerColor = null;
                gameState.opponentName = '';
                gameState.opponentColor = null;
                
                roomData = {
                    id: null,
                    players: [],
                    status: 'waiting',
                    createdBy: null,
                    createdAt: null
                };
            }
            
            // 初始化应用
            initApp();
        });
    </script>
</body>
</html>
